<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Uniform buffers and a 3d camera | Learn Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.1">
    
    <meta property="article:modified_time" content="2020-01-11T22:55:08.000Z"><meta property="og:site_name" content="Learn Wgpu"><meta property="og:title" content="Uniform buffers and a 3d camera"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial6-uniforms/"><meta name="twitter:title" content="Uniform buffers and a 3d camera"><meta name="twitter:url" content="/beginner/tutorial6-uniforms/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin R Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.f819bcb6.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.37ce17b6.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.08ab0899.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/19.d0f7c4fc.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/15.d4e54dff.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.d6298df0.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.40391db3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.6b207e74.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.a4373cdd.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.e63e07b6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.71fad022.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.f9d9ed22.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.34af9e75.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.3e9f0e56.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.3456e76f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.03a1d93f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.99131bb5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.7ed3767e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.4de3638a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.d05d69aa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.9922d581.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.e56a57cf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.cde71275.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.0dba9781.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.f819bcb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="active sidebar-link">Uniform buffers and a 3d camera</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#a-perspective-camera" class="sidebar-link">A perspective camera</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#the-uniform-buffer" class="sidebar-link">The uniform buffer</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#uniform-buffers-and-bind-groups" class="sidebar-link">Uniform buffers and bind groups</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#using-the-uniforms-in-the-vertex-shader" class="sidebar-link">Using the uniforms in the vertex shader</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#changing-our-vertices-again" class="sidebar-link">Changing our vertices again</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#a-controller-for-our-camera" class="sidebar-link">A controller for our camera</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="uniform-buffers-and-a-3d-camera"><a href="#uniform-buffers-and-a-3d-camera" class="header-anchor">#</a> Uniform buffers and a 3d camera</h1> <p>While all of our previous work has seemed to be in 2d, we've actually been working in 3d the entire time! That's part of the reason why our <code>Vertex</code> structure has <code>position</code> be an array of 3 floats instead of just 2. We can't really see the 3d-ness of our scene, because we're viewing things head on. We're going to change our point of view by creating a <code>Camera</code>.</p> <h2 id="a-perspective-camera"><a href="#a-perspective-camera" class="header-anchor">#</a> A perspective camera</h2> <p>This tutorial is more about learning to use wgpu and less about linear algebra, so I'm going to gloss over a lot of the math involved. There's plenty of reading material online if you're interested in what's going on under the hood. The first thing to know is that we need <code>cgmath = &quot;0.17&quot;</code> in our <code>Cargo.toml</code>.</p> <p>Now that we have a math library, let's put it to use! Create a <code>Camera</code> struct above the <code>State</code> struct.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> Camera <span class="token punctuation">{</span>
    eye<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Point3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Point3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    up<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    aspect<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
    fovy<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
    znear<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
    zfar<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Camera <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">build_view_projection_matrix</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.</span>
        <span class="token keyword">let</span> view <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">look_at</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>eye<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>target<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>up<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.</span>
        <span class="token keyword">let</span> proj <span class="token operator">=</span> cgmath<span class="token punctuation">::</span><span class="token function">perspective</span><span class="token punctuation">(</span>cgmath<span class="token punctuation">::</span><span class="token function">Deg</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>fovy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>aspect<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>znear<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>zfar<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.</span>
        <span class="token keyword">return</span> OPENGL_TO_WGPU_MATRIX <span class="token operator">*</span> proj <span class="token operator">*</span> view<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>build_view_projection_matrix</code> is where the magic happens.</p> <ol><li>The <code>view</code> matrix moves the world to be at the position and rotation of the camera. It's essentialy an the inverse of whatever the transform matrix of the camera would be.</li> <li>The <code>proj</code> matrix warps the scene to give the effect of depth. Without this, objects up close would be the same size as objects far away.</li> <li>Cgmath is built with OpenGL in mind. If we try to use it as is, all our transformations will be out of wack. We'll define this matrix as follows.</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg_attr(rustfmt, rustfmt_skip)]</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> OPENGL_TO_WGPU_MATRIX<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span> <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>I am honestly not equipped to explain how this works, but you can read <a href="https://matthewwellings.com/blog/the-new-vulkan-coordinate-system/" target="_blank" rel="noopener noreferrer">https://matthewwellings.com/blog/the-new-vulkan-coordinate-system/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> if you want to know more. All we need to know is that we need to use <code>OPENGL_TO_WGPU_MATRIX</code> only one time, when we create our projection matrix.</p> <p>Using this conversion matrix means we're going to have to change</p> <p>Now that that's done, let's add a <code>camera</code> field to <code>State</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> State <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    camera<span class="token punctuation">:</span> Camera<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Window<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// let diffuse_bind_group ...</span>

    <span class="token keyword">let</span> camera <span class="token operator">=</span> Camera <span class="token punctuation">{</span>
        <span class="token comment">// position the camera one unit up and 2 units back</span>
        eye<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// have it look at the origin</span>
        target<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// which way is &quot;up&quot;</span>
        up<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token punctuation">::</span><span class="token function">unit_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        aspect<span class="token punctuation">:</span> sc_desc<span class="token punctuation">.</span>width <span class="token keyword">as</span> f32 <span class="token operator">/</span> sc_desc<span class="token punctuation">.</span>height <span class="token keyword">as</span> f32<span class="token punctuation">,</span>
        fovy<span class="token punctuation">:</span> <span class="token number">45.0</span><span class="token punctuation">,</span>
        znear<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
        zfar<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        camera<span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now that we have our camera, and it can make us a view projection matrix, we need somewhere to put it. We also need some way of getting it into our shaders.</p> <h2 id="the-uniform-buffer"><a href="#the-uniform-buffer" class="header-anchor">#</a> The uniform buffer</h2> <p>Up to this point we've used <code>Buffer</code>s to store our vertex and index data, and even to load our textures. We going to use them again to create what's known as a uniform buffer. A uniform is a blob of data that is available to every invocation of a set of shaders. We've technically already used uniforms for our texture and sampler. We're going to use them again to store our view projection matrix. To start let's create a struct to hold our <code>Uniforms</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span> <span class="token comment">// We need this for Rust to store our data correctly for the shaders</span>
<span class="token attribute attr-name">#[derive(Debug, Copy, Clone)]</span> <span class="token comment">// This is so we can store this in a buffer</span>
<span class="token keyword">struct</span> Uniforms <span class="token punctuation">{</span>
    view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> cgmath<span class="token punctuation">::</span>SquareMatrix<span class="token punctuation">;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            view_proj<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Camera<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_proj <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">build_view_projection_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now that we have our data structured, let's make our <code>uniform_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// in new() after creating `camera`</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> uniforms <span class="token operator">=</span> Uniforms<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
uniforms<span class="token punctuation">.</span><span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_buffer <span class="token operator">=</span> device
    <span class="token comment">// The COPY_DST part will be important later</span>
    <span class="token punctuation">.</span><span class="token function">create_buffer_mapped</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>UNIFORM <span class="token operator">|</span> wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>COPY_DST<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fill_from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>uniforms<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="uniform-buffers-and-bind-groups"><a href="#uniform-buffers-and-bind-groups" class="header-anchor">#</a> Uniform buffers and bind groups</h2> <p>Cool, now that we have a uniform buffer, what do we do with it? The answer is we create a bind group for it. First we have to create the bind group layout.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutBinding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span> <span class="token comment">// 1.</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>UniformBuffer <span class="token punctuation">{</span>
                dynamic<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token comment">// 2.</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>We only really need camera information in the vertex shader, as that's what we'll use to manipulate our vertices.</li> <li>The <code>dynamic</code> field indicates whether this buffer will change size or not. This is useful if we want to store an array of things in our uniforms.</li></ol> <p>Now we can create the actual bind group.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span>Buffer <span class="token punctuation">{</span>
                buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_buffer<span class="token punctuation">,</span>
                <span class="token comment">// FYI: you can share a single buffer between bindings.</span>
                range<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">..</span>std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span><span class="token function">size_of_val</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uniforms<span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Like with our texture, we need to register our <code>uniform_bind_group_layout</code> with the render pipeline.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>PipelineLayoutDescriptor <span class="token punctuation">{</span>
    bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we need to add <code>uniform_buffer</code> and <code>uniform_bind_group</code> to <code>State</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> State <span class="token punctuation">{</span>
    camera<span class="token punctuation">:</span> Camera<span class="token punctuation">,</span>
    uniforms<span class="token punctuation">:</span> Uniforms<span class="token punctuation">,</span>
    uniform_buffer<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>Buffer<span class="token punctuation">,</span>
    uniform_bind_group<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindGroup<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Window<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        camera<span class="token punctuation">,</span>
        uniforms<span class="token punctuation">,</span>
        uniform_buffer<span class="token punctuation">,</span>
        uniform_bind_group<span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The final thing we need to do before we get into shaders is use the bind group in <code>render()</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffers</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="using-the-uniforms-in-the-vertex-shader"><a href="#using-the-uniforms-in-the-vertex-shader" class="header-anchor">#</a> Using the uniforms in the vertex shader</h2> <p>Modify <code>shader.vert</code> to include the following.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 1.</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span> <span class="token comment">// 2.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    <span class="token comment">// UPDATED!</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>Because we've created a new bind group, we need to specify which one we're using in the shader. The number is determined by our <code>render_pipeline_layout</code>. The <code>texture_bind_group_layout</code> is listed first, thus it's <code>set=0</code>, and <code>uniform_bind_group</code> is second, so it's <code>set=1</code>.</li> <li>The <code>uniform</code> block requires us to specify global identifiers for all the fields we intend to use. It's important to only specify fields that are actually in our uniform buffer, as trying to access data that isn't there may lead to undefined behavior.</li> <li>Multiplication order is important when it comes to matrices. The vector always goes on the right, and the matrices gone on the left in order of importance.</li></ol> <h2 id="changing-our-vertices-again"><a href="#changing-our-vertices-again" class="header-anchor">#</a> Changing our vertices again</h2> <p>Because our correction matrix makes positive y up. Our model is not only upside down, it's also facing the wrong way. This might make you think that adding our correction matrix was a mistake, and you'd have a point. The thing is, most models you find online, and most modeling software expects y to be up. If we try to render any models without the correction matrix, they will likely be upside-down and inside-out. Since our model is still very simple we can easily change it to work with our new setup.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> VERTICES<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>Vertex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
    Vertex <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0868241</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.49240386</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.4131759</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.00759614</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// A</span>
    Vertex <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.49513406</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.06958647</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.0048659444</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.43041354</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// B</span>
    Vertex <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.21918549</span><span class="token punctuation">,</span> <span class="token number">0.44939706</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.28081453</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.949397057</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// C</span>
    Vertex <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.35966998</span><span class="token punctuation">,</span> <span class="token number">0.3473291</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.85967</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.84732911</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// D</span>
    Vertex <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.44147372</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.2347359</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.9414737</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.2652641</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// E</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> INDICES<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>u16<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="a-controller-for-our-camera"><a href="#a-controller-for-our-camera" class="header-anchor">#</a> A controller for our camera</h2> <p>If you run the code right now, you should get something that looks like this.</p> <p><img src="static_tree.png" alt="static_tree.png"></p> <p>The shape's less stretched now, but it's still pretty static. You can experiment with moving the camera position around, but most cameras in games move around. Since this tutorial is about using wgpu and not how to process user input, I'm just going to post the <code>CameraController</code> code below.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> CameraController <span class="token punctuation">{</span>
    speed<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
    is_up_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    is_down_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    is_forward_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    is_backward_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    is_left_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
    is_right_pressed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> CameraController <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>speed<span class="token punctuation">:</span> f32<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            speed<span class="token punctuation">,</span>
            is_up_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            is_down_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            is_forward_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            is_backward_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            is_left_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            is_right_pressed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function">process_events</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span>WindowEvent<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> bool <span class="token punctuation">{</span>
        <span class="token keyword">match</span> event <span class="token punctuation">{</span>
            WindowEvent<span class="token punctuation">::</span>KeyboardInput <span class="token punctuation">{</span>
                input<span class="token punctuation">:</span> KeyboardInput <span class="token punctuation">{</span>
                    state<span class="token punctuation">,</span>
                    virtual_keycode<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>keycode<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">..</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span>
            <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> is_pressed <span class="token operator">=</span> <span class="token operator">*</span>state <span class="token operator">==</span> ElementState<span class="token punctuation">::</span>Pressed<span class="token punctuation">;</span>
                <span class="token keyword">match</span> keycode <span class="token punctuation">{</span>
                    VirtualKeyCode<span class="token punctuation">::</span>Space <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_up_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    VirtualKeyCode<span class="token punctuation">::</span>LShift <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_down_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    VirtualKeyCode<span class="token punctuation">::</span>W <span class="token operator">|</span> VirtualKeyCode<span class="token punctuation">::</span>Up <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_forward_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    VirtualKeyCode<span class="token punctuation">::</span>A <span class="token operator">|</span> VirtualKeyCode<span class="token punctuation">::</span>Left <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_left_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    VirtualKeyCode<span class="token punctuation">::</span>S <span class="token operator">|</span> VirtualKeyCode<span class="token punctuation">::</span>Down <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_backward_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    VirtualKeyCode<span class="token punctuation">::</span>D <span class="token operator">|</span> VirtualKeyCode<span class="token punctuation">::</span>Right <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_right_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token keyword">true</span>
                    <span class="token punctuation">}</span>
                    _ <span class="token operator">=&gt;</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=&gt;</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function">update_camera</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> Camera<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> cgmath<span class="token punctuation">::</span>InnerSpace<span class="token punctuation">;</span>
        <span class="token keyword">let</span> forward <span class="token operator">=</span> <span class="token punctuation">(</span>camera<span class="token punctuation">.</span>target <span class="token operator">-</span> camera<span class="token punctuation">.</span>eye<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_forward_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">+=</span> forward <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_backward_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">-=</span> forward <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> right <span class="token operator">=</span> forward<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>up<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_right_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">+=</span> right <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_left_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">-=</span> right <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This code is not perfect. The camera slowly moves back when you rotate it. It works for our purposes though. Feel free to improve it!</p> <p>We still need to plug this into our existing code to make it do anything. Add the controller to <code>State</code> and create it in <code>new()</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> State <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    camera<span class="token punctuation">:</span> Camera<span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    camera_controller<span class="token punctuation">:</span> CameraController<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">impl</span> State <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Window<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> camera_controller <span class="token operator">=</span> CameraController<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            camera_controller<span class="token punctuation">,</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We're finally going to add some code to <code>input()</code> (assuming you haven't already)!</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span>WindowEvent<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> bool <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>camera_controller<span class="token punctuation">.</span><span class="token function">process_events</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Up to this point, the camera controller isn't actually doing anything. The values in our uniform buffer need to be updated. There are 2 main methods to do that.</p> <ol><li>We can create a separate buffer and copy it's contents to our <code>uniform_buffer</code>. The new buffer is known as a staging buffer. This method is usually how it's done as it allows the contents of the main buffer (in this case <code>uniform_buffer</code>) to only be accessible by the gpu. The gpu can do some speed optimizations which it couldn't if we could access the buffer via the cpu.</li> <li>We can call on of the mapping method's <code>map_read_async</code>, and <code>map_write_async</code> on the buffer itself. These allow us to access a buffer's contents directly, but requires us to deal with the <code>async</code> aspect of these methods this also requires our buffer to use the <code>BufferUsage::MAP_READ</code> and/or <code>BufferUsage::MAP_WRITE</code>. We won't talk about it here, but you check out <a href="../../intermediate/windowless">Wgpu without a window</a> tutorial if you want to know more.</li></ol> <p>Enough about that though, let's get into actually implementing the code.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>camera_controller<span class="token punctuation">.</span><span class="token function">update_camera</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span><span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Copy operation's are performed on the gpu, so we'll need</span>
    <span class="token comment">// a CommandEncoder for that</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>CommandEncoderDescriptor <span class="token punctuation">{</span>
        todo<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> staging_buffer <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device
        <span class="token punctuation">.</span><span class="token function">create_buffer_mapped</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>COPY_SRC<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fill_from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    encoder<span class="token punctuation">.</span><span class="token function">copy_buffer_to_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>staging_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span>size_of<span class="token punctuation">::</span><span class="token operator">&lt;</span>Uniforms<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We need to remember to submit our CommandEncoder's output</span>
    <span class="token comment">// otherwise we won't see any change.</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That's all we need to do. If you run the code now you should see a pentagon with our tree texture that you can rotate around and zoom into with the wasd/arrow keys.</p> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>Have our model rotate on it's own independently of the the camera. <em>Hint: you'll need another matrix for this.</em></p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial6-uniforms/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/11/2020, 3:55:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial5-textures/" class="prev">
          Textures and bind groups
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial7-instancing/">
          Instancing
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.37ce17b6.js" defer></script><script src="/learn-wgpu/assets/js/2.08ab0899.js" defer></script><script src="/learn-wgpu/assets/js/19.d0f7c4fc.js" defer></script><script src="/learn-wgpu/assets/js/15.d4e54dff.js" defer></script>
  </body>
</html>
