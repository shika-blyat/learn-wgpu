<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Working with Lights | Learn Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.1">
    
    <meta property="article:modified_time" content="2020-03-18T02:20:05.000Z"><meta property="og:site_name" content="Learn Wgpu"><meta property="og:title" content="Working with Lights"><meta property="og:type" content="website"><meta property="og:url" content="/intermediate/tutorial10-lighting/"><meta name="twitter:title" content="Working with Lights"><meta name="twitter:url" content="/intermediate/tutorial10-lighting/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin R Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.f819bcb6.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.37ce17b6.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.08ab0899.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/6.9922d581.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/15.d4e54dff.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.d6298df0.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.40391db3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.6b207e74.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.a4373cdd.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.e63e07b6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.71fad022.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.f9d9ed22.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.34af9e75.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.d0f7c4fc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.3e9f0e56.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.3456e76f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.03a1d93f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.99131bb5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.7ed3767e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.4de3638a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.d05d69aa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.e56a57cf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.cde71275.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.0dba9781.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.f819bcb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="active sidebar-link">Working with Lights</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial10-lighting/#ray-path-tracing" class="sidebar-link">Ray/Path Tracing</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial10-lighting/#gouraud-shading" class="sidebar-link">Gouraud Shading</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial10-lighting/#blinn-phong-shading" class="sidebar-link">Blinn-Phong Shading</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="working-with-lights"><a href="#working-with-lights" class="header-anchor">#</a> Working with Lights</h1> <p>While we can tell that our scene is 3d because of our camera, it still feels very flat. That's because our model stays the same color regardless of how it's oriented. If we want to change that we need to add lighting to our scene.</p> <p>In the real world, a light source emits photons which bounce around until they enter into our eyes. The color we see is the light's original color minus whatever energy it lost while it was bouncing around.</p> <p>In the computer graphics world, modeling individual photons would be hilariously computationally expensive. A single 100 Watt light bulb emits about 3.27 x 10^20 photons <em>per second</em>. Just imagine that for the sun! To get around this, we're gonna use math to cheat.</p> <p>Let's discuss a few options.</p> <h2 id="ray-path-tracing"><a href="#ray-path-tracing" class="header-anchor">#</a> Ray/Path Tracing</h2> <p>This is an <em>advanced</em> topic, and we won't be covering it in depth here. It's the closest model to the way light really works so I felt I had to mention it. Check out the <a href="/learn-wgpu/todo/">ray tracing tutorial</a> if you want to learn more.</p> <h2 id="gouraud-shading"><a href="#gouraud-shading" class="header-anchor">#</a> Gouraud Shading</h2> <p>Named after <a href="https://en.wikipedia.org/wiki/Gouraud_shading" target="_blank" rel="noopener noreferrer">Henri Gourad<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, Gourad shading uses a surface normal vector per vertex to determine what direction the surface is facing and then compares that normal to the light's direction to calculate how bright the surface should be. Normals indicate what direction a surface is facing. We compare the normal to light vector to calculate how bright a given part of the model should be.</p> <p><img src="/learn-wgpu/assets/img/normals.a8c2cf99.png" alt="normals.png"></p> <p>Fortunately for use our cube already has normals that we can use. We can get straight to changing our vertex shader to use our normals.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span> <span class="token comment">// NEW</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span> <span class="token comment">// NEW</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token keyword">buffer</span> Instances <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> s_models<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>

    <span class="token comment">// UPDATED</span>
    <span class="token keyword">mat4</span> model <span class="token operator">=</span> s_models<span class="token punctuation">[</span>gl_InstanceIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    v_normal <span class="token operator">=</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token keyword">mat3</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We pull out the model-view-projection matrix that we use to transform our model, because we are going to need it transform our normals. Because a normal is just a direction, not a position, we need to pull out the rotational part of the <code>model</code> matrix. That's why we convert it to <code>mat3</code>. I'm not sure why the <code>transpose</code> and <code>invert</code> bit are needed, but they are.</p> <p>The fragment shader will take that normal, and a new <code>u_light</code> uniform, and perform the calculation.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> f_color<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> texture2D t_diffuse<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> sampler s_diffuse<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token keyword">uniform</span> Lights <span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> u_light<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> diffuse <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">)</span><span class="token punctuation">,</span> v_tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> brightness <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>u_light<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1.</span>
    <span class="token keyword">vec4</span> ambient <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2.</span>
    f_color <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span>ambient<span class="token punctuation">,</span> diffuse<span class="token punctuation">,</span> brightness<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>The dot product gives us the cosine of the angle between the two vectors multiplied by the magnitude of each vector. Normalizing the vectors gives them a magnitude of one, so we get just the cosine of the angle between the two. We can use this value to determine how &quot;similar&quot; they are. A value of 1.0 means that the vectors are the same. A value of -1.0 means that they point in opposite directions.</li> <li>The ambient value is the color the object would be in the dark.</li> <li>We get the final color by mixing the ambient and diffuse colors using our brightness value.</li></ol> <p>Before we can see the results, we need to create the uniform buffer to hold the light data. We're going to create a new buffer to make it easier to store multiple lights.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone)]</span>
<span class="token keyword">struct</span> Light <span class="token punctuation">{</span>
    direction<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> light <span class="token operator">=</span> Light <span class="token punctuation">{</span>
    direction<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> light_buffer <span class="token operator">=</span> device
    <span class="token punctuation">.</span><span class="token function">create_buffer_mapped</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>UNIFORM<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fill_from_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>light<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We need to update the uniform bind group as well.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutBinding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>FRAGMENT<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>UniformBuffer <span class="token punctuation">{</span>
                dynamic<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    bindings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        wgpu<span class="token punctuation">::</span>Binding <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span>Buffer <span class="token punctuation">{</span>
                buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>light_buffer<span class="token punctuation">,</span>
                range<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">..</span>std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span><span class="token function">size_of_val</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>light<span class="token punctuation">)</span> <span class="token keyword">as</span> wgpu<span class="token punctuation">::</span>BufferAddress<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With all that you should get something that looks like this.</p> <p><img src="/learn-wgpu/assets/img/gouraud.23403f2d.png" alt="gouraud.png"></p> <p>You can see they cubes now have a light side and a dark side.</p> <h2 id="blinn-phong-shading"><a href="#blinn-phong-shading" class="header-anchor">#</a> Blinn-Phong Shading</h2> <p>Gouraud shading works, but it's not super accurate. It's missing specular reflection.</p> <p>Specular reflection is the light that's reflected of surface without getting scattered as the diffuse reflection. It's the bright spots you see on s shiny surface such as an apple.</p> <p>Fortunately we only have to change the shader code to get this new effect.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.vert</span>
<span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_normal<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token keyword">buffer</span> Instances <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> s_models<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>

    <span class="token keyword">mat4</span> model <span class="token operator">=</span> s_models<span class="token punctuation">[</span>gl_InstanceIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Rotate the normals with respect to the model, ignoring scaling</span>
    <span class="token keyword">mat3</span> normal_matrix <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token keyword">mat3</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_normal <span class="token operator">=</span> normal_matrix <span class="token operator">*</span> a_normal<span class="token punctuation">;</span>

    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the position relative to the view for the lighting calc</span>
    v_position <span class="token operator">=</span> gl_Position<span class="token punctuation">.</span>xyz <span class="token operator">/</span> gl_Position<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.frag</span>
<span class="token preprocessor builtin">#version</span> <span class="token number">450</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_normal<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> v_position<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> f_color<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> texture2D t_diffuse<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> sampler s_diffuse<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token keyword">uniform</span> Lights <span class="token punctuation">{</span>
    <span class="token keyword">vec3</span> u_light<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">vec3</span> ambient_color <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">vec3</span> specular_color <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> diffuse_color <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">)</span><span class="token punctuation">,</span> v_tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> diffuse_term <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>u_light<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> camera_dir <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token operator">-</span>v_position<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This is an aproximation of the actual reflection vector, aka what</span>
    <span class="token comment">// angle you have to look at the object to be blinded by the light</span>
    <span class="token keyword">vec3</span> half_direction <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>u_light<span class="token punctuation">)</span> <span class="token operator">+</span> camera_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> specular_term <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>v_normal<span class="token punctuation">)</span><span class="token punctuation">,</span> half_direction<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shininess<span class="token punctuation">)</span><span class="token punctuation">;</span>

    f_color <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>ambient_color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>specular_term <span class="token operator">*</span> specular_color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> diffuse_term <span class="token operator">*</span> diffuse_color<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>With that we should get something like this.</p> <p><img src="/learn-wgpu/assets/img/blinn-phong.a3b78226.png" alt="./blinn-phong.png"></p> <p>This is a bit bright for a brick texture though. You can modify the <code>shininess</code> value if you want to reduce the brightness. I'm going to leave it as is though. The lighting calculations will change as we get into <a href="../tutorial11-normals">Normal Mapping</a>.</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/intermediate/tutorial10-lighting/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/17/2020, 8:20:05 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial9-models/" class="prev">
          Model Loading
        </a></span> <span class="next"><a href="/learn-wgpu/showcase/">
          Foreward
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.37ce17b6.js" defer></script><script src="/learn-wgpu/assets/js/2.08ab0899.js" defer></script><script src="/learn-wgpu/assets/js/6.9922d581.js" defer></script><script src="/learn-wgpu/assets/js/15.d4e54dff.js" defer></script>
  </body>
</html>
